<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ambulance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body {
      background: radial-gradient(circle at top left, #0f2027, #203a43, #2c5364);
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      padding: 40px 0;
    }
    .dashboard-wrapper {
      max-width: 1100px;
      margin: auto;
      background-color: #1a1a2e;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
    }
    .btn-custom {
      font-size: 1.1rem;
      padding: 12px;
      border-radius: 12px;
    }
    .status-indicator {
      margin-top: 20px;
      font-size: 1rem;
      padding: 10px;
      border-radius: 8px;
      display: inline-block;
    }
    input, select {
      border-radius: 10px !important;
    }
    label {
      margin-bottom: 0.3rem;
    }
    h4 {
      color: #ffc107;
    }
  </style>
</head>
<body>
  <div class="dashboard-wrapper">
    <h2 class="text-center mb-4">üöë Ambulance Dashboard</h2>

    <!-- Control Buttons -->
    <div class="d-flex justify-content-center gap-3 mb-4">
      <button class="btn btn-success btn-custom" onclick="startAlert()">Send Emergency Alert</button>
      <button class="btn btn-danger btn-custom" onclick="stopAlert()">Clear Alert</button>
    </div>

    <div class="form-check form-switch text-center mb-4">
      <input class="form-check-input" type="checkbox" role="switch" id="locationSwitch" onchange="toggleTracking(this)">
      <label class="form-check-label" for="locationSwitch">Live Location Tracking</label>
    </div>

    <div id="status" class="status-indicator bg-secondary text-center">Alert: INACTIVE</div>

    <hr class="my-4">

    <!-- Two Columns: Patient Info and Ambulance Info -->
    <div class="row g-4">
      <!-- Patient Info Form -->
      <div class="col-md-6">
        <h4>üßë‚Äç‚öïÔ∏è Patient Details</h4>
        <form onsubmit="submitPatientInfo(event)">
          <div class="mb-2">
            <label>Patient Name</label>
            <input type="text" id="patientName" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Age / Gender</label>
            <input type="text" id="patientAgeGender" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Emergency Type</label>
            <input type="text" id="emergencyType" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Condition</label>
            <input type="text" id="patientCondition" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Destination Hospital</label>
            <input type="text" id="hospital" class="form-control" required>
          </div>
          <button class="btn btn-info mt-2 w-100" type="submit">Submit Patient Info</button>
        </form>
      </div>

      <!-- Ambulance Info Form -->
      <div class="col-md-6">
        <h4>üöë Ambulance Details</h4>
        <form onsubmit="submitAmbulanceInfo(event)">
          <div class="mb-2">
            <label>Ambulance ID</label>
            <input type="text" id="ambId" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Driver Name</label>
            <input type="text" id="driverName" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Contact</label>
            <input type="text" id="driverContact" class="form-control" required>
          </div>
          <div class="mb-2">
            <label>Status</label>
            <select id="ambStatus" class="form-select" required>
              <option value="">Select</option>
              <option value="Available">Available</option>
              <option value="En Route">En Route</option>
              <option value="Returning">Returning</option>
            </select>
          </div>
          <button class="btn btn-warning mt-2 w-100" type="submit">Submit Ambulance Info</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    firebase.auth().onAuthStateChanged((user) => {
  if (!user) {
    window.location.href = "login.html"; // redirect if not logged in
  }
});
    let trackingInterval = null;

    function startAlert() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      // 1. Set ambulance alert + location
      db.ref("ambulance").update({
        alert: true,
        location: { lat, lng }
      }).then(() => {
        document.getElementById("status").textContent = "Alert: ACTIVE";
        document.getElementById("status").className = "status-indicator bg-danger";

        // 2. Fetch patient info and log alert
        db.ref("ambulance/patientInfo").once("value").then((snapshot) => {
          const info = snapshot.val() || {};
          const alertData = {
            name: info.name || "Unknown",
            hospital: info.hospital || "Unknown",
            location: { lat, lng },
            status: "active",
            time: Date.now()
          };
          db.ref("alerts").push(alertData);
        });
      });
    }, () => {
      alert("Location access denied. Please enable GPS.");
    });
  } else {
    alert("Geolocation is not supported by this browser.");
  }
}


    function stopAlert() {
      db.ref("ambulance/alert").set(false).then(() => {
        document.getElementById("status").textContent = "Alert: INACTIVE";
        document.getElementById("status").className = "status-indicator bg-secondary";
      });
    }

    function updateLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          db.ref("ambulance/location").set({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          });
        });
      }
    }

    function toggleTracking(toggle) {
      if (toggle.checked) {
        updateLocation();
        trackingInterval = setInterval(updateLocation, 5000);
      } else {
        clearInterval(trackingInterval);
      }
    }

    function submitPatientInfo(event) {
      event.preventDefault();
      const patientName = document.getElementById("patientName").value;
      const patientAgeGender = document.getElementById("patientAgeGender").value;
      const emergencyType = document.getElementById("emergencyType").value;
      const patientCondition = document.getElementById("patientCondition").value;
      const hospital = document.getElementById("hospital").value;

      db.ref("ambulance/patientInfo").set({
        name: patientName,
        ageGender: patientAgeGender,
        emergencyType: emergencyType,
        condition: patientCondition,
        hospital: hospital
      }).then(() => {
        Swal.fire({
  icon: 'success',
  title: 'Patient Info Submitted',
  text: 'Details have been shared with the hospital.',
  confirmButtonText: 'OK',
  backdrop: true,
  position: 'center',
  timer: 3000
});

      });
    }

    function submitAmbulanceInfo(event) {
      event.preventDefault();
      const ambId = document.getElementById("ambId").value;
      const driverName = document.getElementById("driverName").value;
      const driverContact = document.getElementById("driverContact").value;
      const ambStatus = document.getElementById("ambStatus").value;

      db.ref("ambulance/ambInfo").set({
        ambId,
        driver: driverName,
        contact: driverContact,
        status: ambStatus
      }).then(() => {
        Swal.fire({
  icon: 'info',
  title: 'Ambulance Info Updated',
  text: 'Details have been pushed to the admin dashboard.',
  confirmButtonText: 'OK',
  backdrop: true,
  position: 'center',
  timer: 3000
});

      });
    }
  </script>
</body>
</html>
